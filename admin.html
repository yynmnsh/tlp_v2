<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BTF5965 - Admin Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Alfa+Slab+One&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 2rem;
        }

        .admin-container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 1rem;
            box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1);
            overflow: hidden;
        }

        .admin-header {
            background: linear-gradient(135deg, #2563eb, #1d4ed8);
            color: white;
            padding: 2rem;
            text-align: center;
        }

        .admin-title {
            font-family: 'Alfa Slab One', serif;
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }

        .admin-subtitle {
            opacity: 0.9;
            font-size: 1.1rem;
        }

        .admin-content {
            padding: 2rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: #f8fafc;
            padding: 1.5rem;
            border-radius: 0.75rem;
            border: 1px solid #e2e8f0;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            color: #2563eb;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            color: #64748b;
            font-weight: 500;
        }

        .actions-section {
            margin: 2rem 0;
        }

        .section-title {
            font-family: 'Alfa Slab One', serif;
            font-size: 1.5rem;
            margin-bottom: 1rem;
            color: #0f172a;
        }

        .action-buttons {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            margin-bottom: 2rem;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: #2563eb;
            color: white;
        }

        .btn-primary:hover {
            background: #1d4ed8;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #64748b;
            color: white;
        }

        .btn-secondary:hover {
            background: #475569;
            transform: translateY(-2px);
        }

        .btn-danger {
            background: #dc2626;
            color: white;
        }

        .btn-danger:hover {
            background: #b91c1c;
            transform: translateY(-2px);
        }

        .btn-success {
            background: #059669;
            color: white;
        }

        .btn-success:hover {
            background: #047857;
            transform: translateY(-2px);
        }

        .entries-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
            background: white;
            border-radius: 0.5rem;
            overflow: hidden;
            box-shadow: 0 1px 3px rgb(0 0 0 / 0.1);
        }

        .entries-table th,
        .entries-table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }

        .entries-table th {
            background: #f8fafc;
            font-weight: 600;
            color: #374151;
        }

        .entries-table tr:hover {
            background: #f8fafc;
        }

        .device-info {
            font-size: 0.875rem;
            color: #64748b;
        }

        .feedback-text {
            max-width: 300px;
            overflow: visible !important;
            text-overflow: unset !important;
            white-space: normal !important;
        }

        .gif-indicator {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            background: #059669;
            color: white;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .no-gif {
            background: #94a3b8;
        }

        .charts-section {
            margin: 2rem 0;
        }

        .chart-container {
            background: #f8fafc;
            padding: 1.5rem;
            border-radius: 0.75rem;
            margin: 1rem 0;
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: #64748b;
        }

        /* CSV Import Section Styles */
        .csv-import-section {
            background: #f8fafc;
            padding: 1.5rem;
            border-radius: 0.75rem;
            margin: 2rem 0;
            border: 2px dashed #e2e8f0;
        }

        .csv-import-section.active {
            border-color: #2563eb;
            background: rgba(37, 99, 235, 0.05);
        }

        .file-input-hidden {
            display: none;
        }

        .csv-files-list {
            margin: 1rem 0;
        }

        .csv-file-item {
            background: white;
            padding: 0.75rem;
            border-radius: 0.5rem;
            margin: 0.5rem 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid #e2e8f0;
        }

        .csv-file-name {
            font-weight: 500;
            color: #0f172a;
        }

        .csv-file-info {
            font-size: 0.875rem;
            color: #64748b;
        }

        .remove-csv-btn {
            background: #dc2626;
            color: white;
            border: none;
            padding: 0.25rem 0.75rem;
            border-radius: 0.25rem;
            cursor: pointer;
            font-size: 0.875rem;
        }

        .remove-csv-btn:hover {
            background: #b91c1c;
        }

        .data-source-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            background: #3b82f6;
            color: white;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 0.5rem;
        }

        .data-source-local {
            background: #64748b;
        }

        .data-source-csv {
            background: #059669;
        }

        .data-source-netlify {
            background: #3b82f6;
        }

        @media (max-width: 768px) {
            .admin-container {
                margin: 1rem;
            }
            
            .admin-content {
                padding: 1rem;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .entries-table {
                font-size: 0.875rem;
            }
        }
    </style>
</head>
<body>
    <div class="admin-container">
        <div class="admin-header">
            <h1 class="admin-title">BTF5965</h1>
            <p class="admin-subtitle">Tax Law Tutorial - Admin Dashboard</p>
        </div>

        <div class="admin-content">
            <!-- Statistics Section -->
            <div class="stats-grid" id="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="total-entries">-</div>
                    <div class="stat-label">Total Entries</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="unique-students">-</div>
                    <div class="stat-label">Unique Students</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="entries-with-feedback">-</div>
                    <div class="stat-label">Entries with Feedback</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="most-common-schedule">-</div>
                    <div class="stat-label">Most Common Schedule</div>
                </div>
            </div>

            <!-- Actions Section -->
            <div class="actions-section">
                <h2 class="section-title">Data Management</h2>
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="refreshData()">
                        üìä Refresh Data
                    </button>
                    <button class="btn btn-success" onclick="openCsvImport()">
                        üìÅ Import Data
                    </button>
                    <button class="btn btn-secondary" onclick="exportData()">
                        üíæ Export Data
                    </button>
                    <button class="btn btn-danger" onclick="clearAllData()">
                        üóëÔ∏è Clear All Data
                    </button>
                    <a href="index.html" class="btn btn-primary">
                        üè† Back to Main Site
                    </a>
                </div>
            </div>

            <!-- CSV Import Section (Hidden by default) -->
            <div id="csv-import-section" class="csv-import-section" style="display: none;">
                <h3 style="margin-bottom: 1rem;">Import CSV Files</h3>
                <p style="color: #64748b; margin-bottom: 1rem;">Upload one or more CSV files containing attendance data</p>
                
                <input type="file" id="csv-file-input" class="file-input-hidden" accept=".csv" multiple>
                
                <button class="btn btn-primary" onclick="document.getElementById('csv-file-input').click()">
                    Choose CSV Files
                </button>
                
                <div id="csv-files-list" class="csv-files-list"></div>
                
                <div style="margin-top: 1rem; display: flex; gap: 1rem;">
                    <button class="btn btn-success" onclick="processCsvFiles()" id="process-csv-btn" disabled>
                        Process & Import
                    </button>
                    <button class="btn btn-secondary" onclick="closeCsvImport()">
                        Cancel
                    </button>
                </div>
            </div>

            <!-- Device Analytics -->
            <div class="charts-section">
                <h2 class="section-title">Analytics</h2>
                <div class="chart-container">
                    <h3>Schedule Distribution</h3>
                    <div id="schedule-chart"></div>
                </div>
                <div class="chart-container">
                    <h3>Device Types</h3>
                    <div id="device-chart"></div>
                </div>
                <div class="chart-container">
                    <h3>Browsers</h3>
                    <div id="browser-chart"></div>
                </div>
            </div>

            <!-- Entries Table -->
            <div class="entries-section">
                <h2 class="section-title">Recent Entries</h2>
                <div style="overflow-x: auto;">
                    <table class="entries-table" id="entries-table">
                        <thead>
                            <tr>
                                <th>Timestamp</th>
                                <th>Student ID</th>
                                <th>Name</th>
                                <th>Schedule</th>
                                <th>Feedback</th>
                                <th>Source</th>
                            </tr>
                        </thead>
                        <tbody id="entries-tbody">
                            <tr>
                                <td colspan="6" class="loading">Loading entries...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // GitHub Repository Configuration
        const GITHUB_CONFIG = {
            owner: 'yynmnsh',
            repo: 'tlp_v2',
            token: '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',
            branch: 'main'
        };

        // Global variables for CSV handling
        let selectedCsvFiles = [];
        let csvData = [];
        
        class AdminDashboard {
            constructor() {
                this.entries = [];
                this.netlifyEntries = [];
                this.csvEntries = [];
                this.stats = {};
                this.init();
            }
        
            async init() {
                await this.loadData();
                this.updateDisplay();
                this.setupCsvHandlers();
            }

            setupCsvHandlers() {
                const csvFileInput = document.getElementById('csv-file-input');
                csvFileInput.addEventListener('change', handleCsvFileSelect);
            }
        
            async loadData() {
                // Load from localStorage first
                this.entries = JSON.parse(localStorage.getItem('btf5965_entries') || '[]');
                
                // Then try to load from Netlify
                await this.loadNetlifyData();
                
                // Add any CSV entries that were previously imported
                const storedCsvEntries = JSON.parse(localStorage.getItem('btf5965_csv_entries') || '[]');
                this.csvEntries = storedCsvEntries;
                
                // Merge all entries
                this.mergeAllEntries();
                
                this.calculateStats();
            }

            mergeAllEntries() {
                // Start with local entries
                const allEntries = [...this.entries];
                
                // Add Netlify entries (avoiding duplicates)
                this.netlifyEntries.forEach(netlifyEntry => {
                    const exists = allEntries.some(localEntry => 
                        localEntry.studentId === netlifyEntry.studentId && 
                        localEntry.timestamp === netlifyEntry.timestamp
                    );
                    
                    if (!exists) {
                        allEntries.push(netlifyEntry);
                    }
                });
                
                // Add CSV entries (avoiding duplicates)
                this.csvEntries.forEach(csvEntry => {
                    const exists = allEntries.some(entry => 
                        entry.studentId === csvEntry.studentId && 
                        entry.timestamp === csvEntry.timestamp
                    );
                    
                    if (!exists) {
                        allEntries.push(csvEntry);
                    }
                });
                
                this.entries = allEntries;
            }

            addCsvEntries(newCsvEntries) {
                // Add to csvEntries array
                this.csvEntries = [...this.csvEntries, ...newCsvEntries];
                
                // Save to localStorage
                localStorage.setItem('btf5965_csv_entries', JSON.stringify(this.csvEntries));
                
                // Reload and refresh display
                this.loadData();
            }
        
            async loadNetlifyData() {
                try {
                    console.log('Fetching Netlify submissions...');
                    const response = await fetch('/.netlify/functions/get-submissions');
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const submissions = await response.json();
                    console.log(`Loaded ${submissions.length} submissions from Netlify`);
                    
                    // Convert Netlify format to our format
                    this.netlifyEntries = submissions.map(sub => ({
                        studentId: sub.data.studentId,
                        studentName: sub.data.studentName,
                        studentSchedule: sub.data.studentSchedule,
                        feedback: sub.data.feedback,
                        timestamp: sub.created_at,
                        deviceInfo: typeof sub.data.deviceInfo === 'string' ? 
                            JSON.parse(sub.data.deviceInfo) : sub.data.deviceInfo || {},
                        source: 'Netlify'
                    }));
                    
                    // Show status
                    this.showNetlifyStatus(true, submissions.length);
                    
                } catch (error) {
                    console.error('Failed to load Netlify data:', error);
                    this.showNetlifyStatus(false, 0);
                }
            }
        
            showNetlifyStatus(success, count) {
                // Add status indicator to the page
                const headerEl = document.querySelector('.admin-header');
                const existingStatus = document.getElementById('netlify-status');
                
                if (existingStatus) {
                    existingStatus.remove();
                }
                
                const statusEl = document.createElement('div');
                statusEl.id = 'netlify-status';
                statusEl.style.cssText = `
                    background: ${success ? '#10b981' : '#f59e0b'};
                    color: white;
                    padding: 0.5rem 1rem;
                    text-align: center;
                    font-size: 0.9rem;
                `;
                statusEl.textContent = success ? 
                    `‚úî Connected to Netlify Forms (${count} submissions)` : 
                    '‚ö† Using local data only (Netlify connection failed)';
                
                headerEl.appendChild(statusEl);
            }
        
            calculateStats() {
                this.stats = {
                    totalEntries: this.entries.length,
                    uniqueStudents: new Set(this.entries.map(e => e.studentId)).size,
                    entriesWithFeedback: this.entries.filter(e => e.feedback && e.feedback.length > 0).length,
                    schedules: this.entries.reduce((acc, e) => {
                        const schedule = e.studentSchedule || 'Unknown';
                        acc[schedule] = (acc[schedule] || 0) + 1;
                        return acc;
                    }, {}),
                    deviceTypes: this.entries.reduce((acc, e) => {
                        const ua = e.deviceInfo?.userAgent || '';
                        let device = 'Unknown';
                        if (e.source === 'CSV') {
                            device = 'CSV Import';
                        } else if (ua.includes('Mobile')) {
                            device = 'Mobile';
                        } else if (ua.includes('Tablet')) {
                            device = 'Tablet';
                        } else {
                            device = 'Desktop';
                        }
                        acc[device] = (acc[device] || 0) + 1;
                        return acc;
                    }, {}),
                    browsers: this.entries.reduce((acc, e) => {
                        if (e.source === 'CSV') {
                            acc['CSV Import'] = (acc['CSV Import'] || 0) + 1;
                        } else {
                            const ua = e.deviceInfo?.userAgent || '';
                            let browser = 'Unknown';
                            if (ua.includes('Chrome')) browser = 'Chrome';
                            else if (ua.includes('Firefox')) browser = 'Firefox';
                            else if (ua.includes('Safari')) browser = 'Safari';
                            else if (ua.includes('Edge')) browser = 'Edge';
                            acc[browser] = (acc[browser] || 0) + 1;
                        }
                        return acc;
                    }, {})
                };
                
                // Find most common schedule
                const scheduleEntries = Object.entries(this.stats.schedules);
                this.stats.mostCommonSchedule = scheduleEntries.length > 0 ? 
                    scheduleEntries.reduce((a, b) => a[1] > b[1] ? a : b)[0] : 'None';
            }

            updateDisplay() {
                // Update statistics
                document.getElementById('total-entries').textContent = this.stats.totalEntries;
                document.getElementById('unique-students').textContent = this.stats.uniqueStudents;
                document.getElementById('entries-with-feedback').textContent = this.stats.entriesWithFeedback;
                document.getElementById('most-common-schedule').textContent = this.stats.mostCommonSchedule;

                // Update charts
                this.updateScheduleChart();
                this.updateDeviceChart();
                this.updateBrowserChart();

                // Update entries table
                this.updateEntriesTable();
            }

            updateScheduleChart() {
                const chartDiv = document.getElementById('schedule-chart');
                const schedules = this.stats.schedules;
                
                if (Object.keys(schedules).length === 0) {
                    chartDiv.innerHTML = '<p style="color: #64748b;">No data available</p>';
                    return;
                }

                let chartHTML = '';
                Object.entries(schedules)
                    .sort((a, b) => b[1] - a[1]) // Sort by count descending
                    .forEach(([schedule, count]) => {
                        const percentage = ((count / this.stats.totalEntries) * 100).toFixed(1);
                        chartHTML += `
                            <div style="display: flex; justify-content: space-between; align-items: center; margin: 0.5rem 0;">
                                <span style="font-weight: 500;">${schedule}</span>
                                <span style="font-weight: 600; color: #2563eb;">${count} (${percentage}%)</span>
                            </div>
                        `;
                    });
                
                chartDiv.innerHTML = chartHTML;
            }

            updateDeviceChart() {
                const chartDiv = document.getElementById('device-chart');
                const deviceTypes = this.stats.deviceTypes;
                
                if (Object.keys(deviceTypes).length === 0) {
                    chartDiv.innerHTML = '<p style="color: #64748b;">No data available</p>';
                    return;
                }

                let chartHTML = '';
                Object.entries(deviceTypes).forEach(([device, count]) => {
                    const percentage = ((count / this.stats.totalEntries) * 100).toFixed(1);
                    chartHTML += `
                        <div style="display: flex; justify-content: space-between; align-items: center; margin: 0.5rem 0;">
                            <span>${device}</span>
                            <span style="font-weight: 600;">${count} (${percentage}%)</span>
                        </div>
                    `;
                });
                
                chartDiv.innerHTML = chartHTML;
            }

            updateBrowserChart() {
                const chartDiv = document.getElementById('browser-chart');
                const browsers = this.stats.browsers;
                
                if (Object.keys(browsers).length === 0) {
                    chartDiv.innerHTML = '<p style="color: #64748b;">No data available</p>';
                    return;
                }

                let chartHTML = '';
                Object.entries(browsers).forEach(([browser, count]) => {
                    const percentage = ((count / this.stats.totalEntries) * 100).toFixed(1);
                    chartHTML += `
                        <div style="display: flex; justify-content: space-between; align-items: center; margin: 0.5rem 0;">
                            <span>${browser}</span>
                            <span style="font-weight: 600;">${count} (${percentage}%)</span>
                        </div>
                    `;
                });
                
                chartDiv.innerHTML = chartHTML;
            }

            updateEntriesTable() {
                const tbody = document.getElementById('entries-tbody');
                
                if (this.entries.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #64748b;">No entries found</td></tr>';
                    return;
                }

                const sortedEntries = [...this.entries].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                
                tbody.innerHTML = sortedEntries.map(entry => {
                    const timestamp = new Date(entry.timestamp).toLocaleString();
                    const feedbackPreview = entry.feedback ? 
                        (entry.feedback.length > 50 ? entry.feedback.substring(0, 50) + '...' : entry.feedback) : 
                        'No feedback';
                    const schedule = entry.studentSchedule || 'Unknown';
                    
                    // Determine source badge
                    let sourceBadge = '';
                    if (entry.source === 'CSV') {
                        sourceBadge = '<span class="data-source-badge data-source-csv">CSV</span>';
                    } else if (entry.source === 'Netlify') {
                        sourceBadge = '<span class="data-source-badge data-source-netlify">Netlify</span>';
                    } else {
                        sourceBadge = '<span class="data-source-badge data-source-local">Local</span>';
                    }
                    
                    return `
                        <tr>
                            <td>${timestamp}</td>
                            <td>${entry.studentId}</td>
                            <td>${entry.studentName}</td>
                            <td>${schedule}</td>
                            <td class="feedback-text" title="${entry.feedback || 'No feedback'}">${feedbackPreview}</td>
                            <td>${sourceBadge}</td>
                        </tr>
                    `;
                }).join('');
            }
        }

        // CSV Import Functions
        function openCsvImport() {
            const section = document.getElementById('csv-import-section');
            section.style.display = 'block';
            section.classList.add('active');
        }

        function closeCsvImport() {
            const section = document.getElementById('csv-import-section');
            section.style.display = 'none';
            section.classList.remove('active');
            
            // Reset
            selectedCsvFiles = [];
            csvData = [];
            document.getElementById('csv-file-input').value = '';
            document.getElementById('csv-files-list').innerHTML = '';
            document.getElementById('process-csv-btn').disabled = true;
        }

        function handleCsvFileSelect(event) {
            const files = Array.from(event.target.files);
            selectedCsvFiles = files;
            displaySelectedFiles();
            
            // Enable process button if files are selected
            document.getElementById('process-csv-btn').disabled = files.length === 0;
        }

        function displaySelectedFiles() {
            const listDiv = document.getElementById('csv-files-list');
            
            if (selectedCsvFiles.length === 0) {
                listDiv.innerHTML = '';
                return;
            }
            
            listDiv.innerHTML = selectedCsvFiles.map((file, index) => `
                <div class="csv-file-item">
                    <div>
                        <div class="csv-file-name">${file.name}</div>
                        <div class="csv-file-info">Size: ${(file.size / 1024).toFixed(2)} KB</div>
                    </div>
                    <button class="remove-csv-btn" onclick="removeCsvFile(${index})">Remove</button>
                </div>
            `).join('');
        }

        function removeCsvFile(index) {
            selectedCsvFiles.splice(index, 1);
            
            // Update file input
            const dataTransfer = new DataTransfer();
            selectedCsvFiles.forEach(file => dataTransfer.items.add(file));
            document.getElementById('csv-file-input').files = dataTransfer.files;
            
            displaySelectedFiles();
            document.getElementById('process-csv-btn').disabled = selectedCsvFiles.length === 0;
        }

        async function processCsvFiles() {
            if (selectedCsvFiles.length === 0) {
                alert('Please select CSV files to import');
                return;
            }
            
            csvData = [];
            let totalProcessed = 0;
            let errors = [];
            
            for (const file of selectedCsvFiles) {
                try {
                    const text = await readFileAsText(file);
                    
                    // Parse CSV using Papa Parse
                    const result = Papa.parse(text, {
                        header: true,
                        dynamicTyping: true,
                        skipEmptyLines: true,
                        transformHeader: header => header.trim()
                    });
                    
                    if (result.errors.length > 0) {
                        errors.push(`${file.name}: ${result.errors.map(e => e.message).join(', ')}`);
                    }
                    
                    // Process each row
                    const processedData = result.data.map(row => {
                        // Map CSV columns to our data structure
                        // Adjust these mappings based on your CSV structure
                        return {
                            id: generateEntryId(),
                            studentId: String(row['Student ID'] || row['studentId'] || ''),
                            studentName: row['Name'] || row['studentName'] || '',
                            studentSchedule: row['Schedule'] || row['studentSchedule'] || '',
                            feedback: row['Feedback'] || row['feedback'] || '',
                            timestamp: row['Timestamp'] || row['timestamp'] || new Date().toISOString(),
                            source: 'CSV',
                            fileName: file.name,
                            deviceInfo: {
                                userAgent: 'CSV Import',
                                platform: 'CSV',
                                sessionId: generateSessionId()
                            }
                        };
                    }).filter(entry => entry.studentId); // Filter out entries without student ID
                    
                    csvData.push(...processedData);
                    totalProcessed += processedData.length;
                    
                } catch (error) {
                    errors.push(`${file.name}: ${error.message}`);
                }
            }
            
            if (csvData.length > 0) {
                // Add CSV entries to dashboard
                window.adminDashboard.addCsvEntries(csvData);
                
                let message = `Successfully imported ${totalProcessed} entries from ${selectedCsvFiles.length} file(s)`;
                if (errors.length > 0) {
                    message += '\n\nErrors:\n' + errors.join('\n');
                }
                alert(message);
                
                // Close import section
                closeCsvImport();
                
                // Refresh display
                refreshData();
            } else {
                alert('No valid entries found in the CSV files.\n\nErrors:\n' + errors.join('\n'));
            }
        }

        function readFileAsText(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = e => resolve(e.target.result);
                reader.onerror = e => reject(e);
                reader.readAsText(file);
            });
        }

        function generateEntryId() {
            return 'csv_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        function generateSessionId() {
            return 'csv_session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        // Global functions
        async function refreshData() {
            await window.adminDashboard.loadData();
            window.adminDashboard.updateDisplay();
            console.log('Data refreshed. Total entries:', window.adminDashboard.entries.length);
        }

        function exportData() {
            const allData = {
                localEntries: JSON.parse(localStorage.getItem('btf5965_entries') || '[]'),
                csvEntries: JSON.parse(localStorage.getItem('btf5965_csv_entries') || '[]'),
                exportDate: new Date().toISOString()
            };
            
            const dataStr = JSON.stringify(allData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `btf5965_all_entries_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
        }

        function clearAllData() {
            if (confirm('Are you sure you want to clear all stored data? This action cannot be undone.')) {
                localStorage.removeItem('btf5965_entries');
                localStorage.removeItem('btf5965_csv_entries');
                
                // Clear all GIF data
                Object.keys(localStorage).forEach(key => {
                    if (key.startsWith('btf5965_')) {
                        localStorage.removeItem(key);
                    }
                });
                
                window.adminDashboard.loadData();
                window.adminDashboard.updateDisplay();
                alert('All data cleared successfully.');
            }
        }

        // Feedback Modal Functions - Define globally
        window.showFeedbackModal = function(index) {
            const entry = window.displayedEntries[index];
            if (!entry) {
                console.error('Entry not found at index:', index);
                return;
            }
            
            console.log('Showing feedback modal for entry:', entry);
            
            // Populate modal with entry data
            document.getElementById('modal-student-id').textContent = entry.studentId || 'Unknown';
            document.getElementById('modal-student-name').textContent = entry.studentName || 'Unknown';
            document.getElementById('modal-schedule').textContent = entry.studentSchedule || 'Unknown';
            
            let timestamp;
            try {
                timestamp = entry.timestamp ? new Date(entry.timestamp).toLocaleString() : 'Unknown';
            } catch {
                timestamp = entry.timestamp || 'Unknown';
            }
            document.getElementById('modal-timestamp').textContent = timestamp;
            
            // Set source with badge
            let sourceHtml = entry.source || 'Local';
            if (entry.source === 'CSV') {
                sourceHtml = '<span class="data-source-badge data-source-csv">CSV</span>';
            } else if (entry.source === 'Netlify') {
                sourceHtml = '<span class="data-source-badge data-source-netlify">Netlify</span>';
            } else {
                sourceHtml = '<span class="data-source-badge data-source-local">Local</span>';
            }
            document.getElementById('modal-source').innerHTML = sourceHtml;
            
            // Set feedback content
            document.getElementById('modal-feedback-content').textContent = entry.feedback || 'No feedback provided';
            
            // Show modal
            const modal = document.getElementById('feedback-modal');
            if (modal) {
                modal.classList.add('active');
            } else {
                console.error('Feedback modal element not found');
            }
        };

        window.closeFeedbackModal = function() {
            const modal = document.getElementById('feedback-modal');
            if (modal) {
                modal.classList.remove('active');
            }
        };

        // Close modal when clicking outside
        document.addEventListener('click', function(event) {
            const modal = document.getElementById('feedback-modal');
            if (modal && event.target === modal) {
                window.closeFeedbackModal();
            }
        });

        // Close modal with Escape key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                window.closeFeedbackModal();
            }
        });

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', () => {
            window.adminDashboard = new AdminDashboard();
        });
    </script>
</body>
</html>
